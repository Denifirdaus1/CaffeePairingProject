<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Compression Tool - DB Approach</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #fff;
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      color: #999;
      margin-bottom: 40px;
      font-size: 1.1rem;
    }

    .config-panel {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #ddd;
    }

    input[type="range"] {
      width: 100%;
    }

    .slider-group {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 20px;
      align-items: center;
    }

    .value-display {
      background: rgba(102, 126, 234, 0.2);
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 700;
      color: #667eea;
      min-width: 80px;
      text-align: center;
    }

    button {
      width: 100%;
      padding: 16px 32px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-label {
      color: #999;
      font-size: 0.875rem;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .log-container {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 12px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .log-entry {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-success { color: #4ade80; }
    .log-error { color: #f87171; }
    .log-info { color: #60a5fa; }
    .log-warning { color: #fbbf24; }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin: 20px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s ease;
    }

    .alert {
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      border-left: 4px solid;
      background: rgba(96, 165, 250, 0.1);
      border-color: #60a5fa;
      color: #60a5fa;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üñºÔ∏è Image Compression Tool</h1>
    <p class="subtitle">Fetch from database and compress images</p>

    <div class="alert">
      ‚ÑπÔ∏è This tool fetches image URLs from database, downloads, compresses, and uploads back to Supabase Storage.
    </div>

    <div class="config-panel">
      <h2 style="margin-bottom: 20px;">Configuration</h2>

      <div class="form-group slider-group">
        <div>
          <label>Max Width (pixels)</label>
          <input type="range" id="maxWidth" min="400" max="2000" value="1200" step="100">
        </div>
        <div class="value-display" id="widthDisplay">1200px</div>
      </div>

      <div class="form-group slider-group">
        <div>
          <label>Quality (0-100)</label>
          <input type="range" id="quality" min="50" max="100" value="80" step="5">
        </div>
        <div class="value-display" id="qualityDisplay">80%</div>
      </div>

      <button id="startBtn" onclick="startCompression()">
        üöÄ Start Compression
      </button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Images</div>
        <div class="stat-value" id="totalImages">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Processed</div>
        <div class="stat-value" id="processed">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Original Size</div>
        <div class="stat-value" id="originalSize">0 MB</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Compressed Size</div>
        <div class="stat-value" id="compressedSize">0 MB</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Space Saved</div>
        <div class="stat-value" id="savedSpace">0%</div>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progressBar"></div>
    </div>

    <div class="log-container" id="logContainer">
      <div class="log-entry log-info">üìã Ready to compress images. Click "Start Compression" to begin.</div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const SUPABASE_URL = 'https://jjbvliewmcadmxmmcckl.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqYnZsaWV3bWNhZG14bW1jY2tsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyODI1NDMsImV4cCI6MjA3Njg1ODU0M30._5DeurOWNpd08Iq-5hEqh4j2Nsout2AzpRpea8hcaQY';

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    let stats = {
      total: 0,
      processed: 0,
      originalSize: 0,
      compressedSize: 0
    };

    // Update slider displays
    document.getElementById('maxWidth').addEventListener('input', (e) => {
      document.getElementById('widthDisplay').textContent = e.target.value + 'px';
    });

    document.getElementById('quality').addEventListener('input', (e) => {
      document.getElementById('qualityDisplay').textContent = e.target.value + '%';
    });

    function log(message, type = 'info') {
      const container = document.getElementById('logContainer');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
    }

    function updateStats() {
      document.getElementById('totalImages').textContent = stats.total;
      document.getElementById('processed').textContent = stats.processed;
      document.getElementById('originalSize').textContent = (stats.originalSize / 1024 / 1024).toFixed(2) + ' MB';
      document.getElementById('compressedSize').textContent = (stats.compressedSize / 1024 / 1024).toFixed(2) + ' MB';
      
      const saved = stats.originalSize > 0 
        ? ((1 - stats.compressedSize / stats.originalSize) * 100).toFixed(1)
        : 0;
      document.getElementById('savedSpace').textContent = saved + '%';
      
      const progress = stats.total > 0 ? (stats.processed / stats.total * 100) : 0;
      document.getElementById('progressBar').style.width = progress + '%';
    }

    async function compressImage(imageUrl, maxWidth, quality) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        img.onerror = () => reject(new Error('Failed to load image'));
        
        img.onload = () => {
          try {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // Calculate new dimensions
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob(
              (blob) => blob ? resolve(blob) : reject(new Error('Failed to create blob')),
              'image/jpeg',
              quality / 100
            );
          } catch (error) {
            reject(error);
          }
        };

        img.src = imageUrl;
      });
    }

    function extractPathFromUrl(url) {
      try {
        const urlObj = new URL(url);
        const pathParts = urlObj.pathname.split('/');
        const bucketIndex = pathParts.findIndex(part => part === 'coffee-images' || part === 'pastry-images');
        if (bucketIndex === -1) return null;
        
        return {
          bucket: pathParts[bucketIndex],
          path: pathParts.slice(bucketIndex + 1).join('/')
        };
      } catch {
        return null;
      }
    }

    window.startCompression = async function() {
      const maxWidth = parseInt(document.getElementById('maxWidth').value);
      const quality = parseInt(document.getElementById('quality').value);

      const startBtn = document.getElementById('startBtn');
      startBtn.disabled = true;
      startBtn.textContent = '‚è≥ Processing...';

      try {
        log('üìä Fetching images from database...', 'info');

        // Fetch all coffee images
        const { data: coffees, error: coffeeError } = await supabase
          .from('coffees')
          .select('id, name, image_url, image_path')
          .not('image_url', 'is', null);

        if (coffeeError) throw coffeeError;

        // Fetch all pastry images
        const { data: pastries, error: pastryError } = await supabase
          .from('pastries')
          .select('id, name, image_url, image_path')
          .not('image_url', 'is', null);

        if (pastryError) throw pastryError;

        const allImages = [
          ...coffees.map(c => ({ ...c, type: 'coffee' })),
          ...pastries.map(p => ({ ...p, type: 'pastry' }))
        ];

        stats.total = allImages.length;
        updateStats();

        log(`‚úÖ Found ${stats.total} images from database`, 'success');

        // Process each image
        for (const item of allImages) {
          try {
            log(`üîÑ Processing: ${item.name}`, 'info');

            const pathInfo = extractPathFromUrl(item.image_url);
            if (!pathInfo) {
              log(`‚ö†Ô∏è Skipping ${item.name}: Invalid URL format`, 'warning');
              continue;
            }

            // Fetch original image
            const response = await fetch(item.image_url);
            if (!response.ok) throw new Error('Failed to fetch image');
            
            const originalBlob = await response.blob();
            const originalSize = originalBlob.size;
            stats.originalSize += originalSize;

            // Compress
            const compressedBlob = await compressImage(item.image_url, maxWidth, quality);
            const compressedSize = compressedBlob.size;
            stats.compressedSize += compressedSize;

            const savedPercent = ((1 - compressedSize / originalSize) * 100).toFixed(1);

            // Upload compressed version
            const { error: uploadError } = await supabase.storage
              .from(pathInfo.bucket)
              .upload(pathInfo.path, compressedBlob, {
                upsert: true,
                contentType: 'image/jpeg'
              });

            if (uploadError) throw uploadError;

            stats.processed++;
            updateStats();

            log(
              `‚úÖ ${item.name}: ${(originalSize/1024).toFixed(0)}KB ‚Üí ${(compressedSize/1024).toFixed(0)}KB (-${savedPercent}%)`,
              'success'
            );

          } catch (error) {
            log(`‚ùå Failed: ${item.name} - ${error.message}`, 'error');
            stats.processed++;
            updateStats();
          }

          // Small delay to avoid rate limiting
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        log('üéâ Compression complete!', 'success');
        log(`üíæ Total saved: ${((stats.originalSize - stats.compressedSize) / 1024 / 1024).toFixed(2)} MB`, 'success');

        startBtn.textContent = '‚úÖ Done! Refresh to run again';

      } catch (error) {
        log(`‚ùå Fatal error: ${error.message}`, 'error');
        console.error(error);
        startBtn.disabled = false;
        startBtn.textContent = 'üöÄ Start Compression';
      }
    };
  </script>
</body>
</html>

